---
title: "Mandatory homework assignment submission"
author: "Harald Groven"
output:
  html_document:
    df_print: paged
---

Tester ut SSBs API for å hente data demografi i JSON-format, men uten å gjøre noe mer spennende enn gjøre JSON-data om til flate tabeller. 

Plotter tidsseriene ggplot2 og konvertere til web-vennlig format med D3-visualiseringsbiblioteket [Plot.ly](https://plot.ly/r/). 

## Figur 1 Tromsøs befolkning 

Tromsøs befolkningstall pr 1. januar for hvert år siden 1986.

Kilde: [SSBs tabell 26975, Folkemengde kommuner](https://data.ssb.no/api/v0/dataset/26975?lang=no)

```{r setup, include=FALSE}
# Set echo in opts_chunk to FALSE
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(package.startup.message = FALSE)
```

```{r, message=F, warning=F}
# Create a plot of something interesting or something random. It doesn't really matter as long as you create a plot of some data. 
# You can modify and style it as much or as little as you like. 
# In 1-4 sentences either above or bellow the plot, explain what the plot shows.

options(encoding="UTF-8")
library(tidyverse)
library(ggplot2)
library(httr)
library(rjstat)
# I'll stick to the chart library we're using at my workplace 
# install.packages("plotly")
library(plotly)
# Additional style sets for ggplot2 
# install.packages("ggthemes")
# Pretend its the cover story of my favourite news magazine, The Economist!
library(ggthemes)

# SSB Folkemengde. Kommuner, pr. 1.1., 1986 - siste år
# csv 
# ssb_url <- "https://data.ssb.no/api/v0/dataset/26975.csv?lang=no"
# json 
ssb_url <- "https://data.ssb.no/api/v0/dataset/26975.json?lang=nb"

# last ned befolkningsstatistikk fra SSB 
ssb_befolkning_json <- fromJSONstat(content(GET(ssb_url), "text"))
# gjør json til flat tabell
ssb_befolkning <- ssb_befolkning_json[[1]]
# få internasjonale variabelnavn 
names(ssb_befolkning) <- c("region","year","variable","population")
# Viser tabell
# View(ssb_befolkning)

# filter all but Tromsø 
ssb_befolkning_tromso <- dplyr::filter(ssb_befolkning, region == "Tromsø")
# View(ssb_befolkning_tromso)

 
# Basic line plot with points
gg_befolkning <- ggplot(data=ssb_befolkning_tromso, aes(x=year, y=as.numeric(population)))+
  geom_bar(stat="identity", show.legend = TRUE)+
  ylim(0, 80000)+
  ggtitle("Tromsøs befolkning går rett til værs")+
  theme_economist()+
  labs(y = "Befolkning, pr 1. januar", x="År")+
  theme(axis.text.x = element_text(angle=90, vjust=0.5))


#   theme(axis.text.year = element_text(angle = 90, hjust=0))+

# graf i ggplot
# gg_befolkning
# graf i D3-biblioteket Plot.ly
ggplotly(gg_befolkning)
```




## Figur 2 Befolkning i grunnkretser i Tromsø

Befolkningsutvikling i fire grunnkretser i Tromsø siden år 2000.

Kilde: [SSBs tabell 04317: Folkemengde, etter grunnkrets 1999 - 2018](https://www.ssb.no/statbank/table/04317)

```{r, fig.height=4, fig.width=10, message=F, warning=F}
# Create a new **line** plot with something different than the previous. This must be a line plot. 
# Change the size of this plot in the chunk options using fig.height and fig.width. 
# In 1-4 sentences either above or bellow the plot, explain what the plot shows. Create separate sections for each plot using double hashtags

options(encoding="UTF-8")
# read json-stat files 
library(rjstat)
library(httr)
library(ggplot2)
library(plotly)
library(ggthemes)

# befolkning pr grunnkrets 
ssb_url <- "http://data.ssb.no/api/v0/no/table/04317"
# alle grunnkretser i Tromsø kommune (kommunenr begynner på 1902*)
ssb_query <- '
{
  "query": [
    {
      "code": "Grunnkretser",
      "selection": {
        "filter": "all",
        "values": ["1902*"
        ]
      }
    },
    {
      "code": "ContentsCode",
      "selection": {
        "filter": "item",
        "values": [
          "Personer1"
        ]
      }
    },
    {
      "code": "Tid",
      "selection": {
        "filter": "all",
        "values": [
         "20*"
        ]
      }
    }
  ],
  "response": {
    "format": "json-stat"
  }
}
'
ssb_befolkning_grunnkrets_json <- fromJSONstat(content(POST(ssb_url , body = ssb_query, encode = "json", verbose()), "text"))

ssb_befolkning_grunnkrets <- ssb_befolkning_grunnkrets_json[[1]]
names(ssb_befolkning_grunnkrets) <- names(ssb_befolkning) <- c("region","variable","year","population")
# View(ssb_befolkning_grunnkrets)

# for mange grunnkretser i Tromsø til at det var plottbart
# variabelen ssb_befolkning_grunnkrets_f plukker ut tre grunnkretser  
ssb_befolkning_grunnkrets_f <- dplyr::filter(ssb_befolkning_grunnkrets, region %in% c("Breivika", "Hansjordnes", "Bukta", "Stortorget"))
# View(ssb_befolkning_grunnkrets_f)

befolkning_grunnkrets <- ggplot(data=ssb_befolkning_grunnkrets_f, 
    aes(
      x = year, 
      y = population, 
      group = region, 
      color = region
      )
    ) +
    geom_line() +
    geom_point() +
    theme_economist()+
    labs(y = "Befolkning", x="Tid")+
    theme(axis.text.x = element_text(angle=90, vjust=0.5))

# graf i D3-biblioteket Plot.ly
ggplotly(befolkning_grunnkrets)
```
